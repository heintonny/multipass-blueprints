# Azure CLI and PowerShell Environment Setup for Multipass VM
#
# Description:
# This configuration creates a Multipass VM equipped with Azure CLI and PowerShell
# on Ubuntu 22.04 LTS. It is designed for developers and sysadmins who require
# a versatile toolset for managing Azure resources and automating tasks across
# cloud environments. By incorporating both Azure CLI and PowerShell, users gain
# access to a broad range of commands and scripts for comprehensive cloud management.
# This setup is ideal for cross-platform scripting and automation workflows.
#
# Version: 0.1
#
# Compatibility:
# - ARM64
# - x86_64
#
instances:
  azure-cli-pwsh:
    image: 22.04
    limits:
      min-cpu: 1
      min-mem: 2G
      min-disk: 10G
    timeout: 1800
    cloud-init:
      vendor-data: |
        package_update: true
        package_upgrade: true
        package_reboot_if_required: true        

        packages:
        - curl
        - lsb-release
        - apt-transport-https
        - ca-certificates
        - software-properties-common
        - python3-pip
        - jq
        - gnupg
        
        runcmd:        
        - curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        
        - |
          # PowerShell installation steps:
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q "https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb"
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

        # Configuration files and command aliases:
        write_files:

        - content: |            
            source /etc/bash_completion.d/azure-cli
            
          path: /home/ubuntu/.bashrc
          append: true
          defer: true

        - content: |
            Import-Module PSReadLine
            Set-PSReadLineOption -EditMode Emacs
            Set-PSReadLineOption -BellStyle None
          path: /home/ubuntu/.config/powershell/profile.ps1
          
        final_message: "The Azure CLI and PowerShell environment is ready, after $UPTIME seconds."

health-check: |
  set -e
  # Verifying Azure CLI installation:
  az --version
  # Verifying jq installation:
  jq --version
  # Verifying PowerShell installation:
  pwsh -v
